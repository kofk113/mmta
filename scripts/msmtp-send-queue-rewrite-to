#!/bin/sh
# Script to send messages from a mailqueue via msmtp
# Copyright: 2008 Teemu Ikonen <tpikonen@gmail.com>
# License: GPLv3+

[ -x /usr/bin/msmtp ] || exit 1

MAILDIR="/var/mail/$(whoami).mailq"
HEADER="X-mmta-envelope-to:"

HOST=$(sed -n 's/^host\s\s*\(.*\)/\1/p' $HOME/.msmtprc)
ping -c 1 -w 2 $HOST > /dev/null 2>&1
if [ $? != "0" ] ; then
    exit 0
fi

LOCALTO=$(whoami)
INET_TO=$(sed -n 's/^from\s\s*\(.*\)/\1/p' $HOME/.msmtprc)

dotlockfile -p "$MAILDIR/lock"
for M in $(find $MAILDIR/new $MAILDIR/cur -type f) ; do
    RECIPIENTS=$(head -n 1 $M | sed -n "s/^$HEADER//p" | tr ',' ' ') 
# FIXME: sed cmd below does not work for multiline To: headers
    if tail -n +2 $M | \
        sed -e "s/^\(To:.*\)${LOCALTO}$/\1${INET_TO}/" \
             -e "s/^\(To:.*\)${LOCALTO}\([^@].*\)$/\1${INET_TO}\2/" \
        | /usr/bin/msmtp -- $RECIPIENTS ; then
	rm -f $M
    fi
    dotlockfile -t "$MAILDIR/lock"
done
dotlockfile -u "$MAILDIR/lock"
